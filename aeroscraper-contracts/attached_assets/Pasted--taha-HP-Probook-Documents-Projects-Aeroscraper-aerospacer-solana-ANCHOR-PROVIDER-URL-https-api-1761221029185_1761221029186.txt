
taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ ANCHOR_PROVIDER_URL=https://api.devnet.solana.com ANCHOR_WALLET=~/.config/solana/id.json npx ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/protocol-oracle-integration.ts'
(node:1480849) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-oracle-integration.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  Protocol Contract - Oracle Integration Tests

ðŸ”® Setting up Oracle Integration Tests...
Using existing stablecoin mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
Using existing collateral mint: Hygyfy8RBxLvoz5b3ffsg9PAvEkT3BJXXdTpVu6ftZYz
âœ… Setup complete
    Test 7.1: Get Price via CPI Call
ðŸ“‹ Testing oracle CPI price query...
SortedTrovesState has 2 troves, head: H6jcCMEZJvBsyd16VizDF9E6aosUpzuTvjuhk1JWWavw
âœ“ Processed trove H6jcCMEZJvBsyd16VizDF9E6aosUpzuTvjuhk1JWWavw, next: GLThBB9YBHJgQMVj2wGpbLwKwEMfjr1ieVHaqgueYxUn
âœ“ Processed trove GLThBB9YBHJgQMVj2wGpbLwKwEMfjr1ieVHaqgueYxUn, next: null
âœ… Fetched 2 valid trove accounts for traversal
      1) Should query oracle price through CPI
    Test 7.2: ICR Calculation with Real Pyth Prices
ðŸ“‹ Testing ICR calculation with Pyth prices...
      2) Should calculate ICR using real-time Pyth prices
    Test 7.3: Liquidation Threshold with Oracle Prices
ðŸ“‹ Testing liquidation threshold with oracle...
      3) Should determine liquidation threshold from oracle
    Test 7.4: Multi-Collateral Price Queries
ðŸ“‹ Testing multi-collateral support...
  âœ… SOL: Supported via Pyth feed
  âœ… Protocol architecture supports multi-collateral
  âœ… Each denom stored separately in protocol state
âœ… Multi-collateral architecture verified
      âœ” Should support multiple collateral types
    Test 7.5: Price Staleness Handling
ðŸ“‹ Testing price staleness...
  âœ… Local: Uses get_price_unchecked for testing
  âœ… Devnet: Uses get_price with 5-minute staleness check
  âœ… Staleness validation architecture in place
âœ… Price staleness handling verified
      âœ” Should handle price staleness validation
    Test 7.6: Invalid Oracle Account Rejection
ðŸ“‹ Testing oracle account validation...
  âœ… Oracle program ID validated against state
  âœ… Oracle state account validated against state
  âœ… Covered in CPI security tests
âœ… Oracle account validation verified
      âœ” Should reject invalid oracle accounts
    Test 7.7: Oracle State Validation
ðŸ“‹ Testing oracle state validation...
  âœ… Oracle state address matches protocol state
  âœ… Oracle program ID matches protocol state
âœ… Oracle state validation verified
      âœ” Should validate oracle state PDA (519ms)
    Test 7.8: Price Decimal Conversion
ðŸ“‹ Testing decimal conversion...
  Oracle Address: J83w4HKfqxwcq3BEMMkPFSppX3gqekLyLJBexebFVkix
  âœ… Pyth prices have varying exponents
  âœ… Protocol normalizes to 18 decimals
  âœ… Decimal conversion handled in oracle module
âœ… Decimal conversion verified
      âœ” Should handle different decimal places (400ms)


  5 passing (20s)
  3 failing

  1) Protocol Contract - Oracle Integration Tests
       Test 7.1: Get Price via CPI Call
         Should query oracle price through CPI:
     Error: AnchorError caused by account: stability_pool_token_account. Error Code: AccountNotInitialized. Error Number: 3012. Error Message: The program expected this account to be already initialized.
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  2) Protocol Contract - Oracle Integration Tests
       Test 7.2: ICR Calculation with Real Pyth Prices
         Should calculate ICR using real-time Pyth prices:
     Error: Account does not exist or has no data Hajx4D2ojsjfioEkVosNjHEFC6z5zCXms5A6VmwjBapz
      at AccountClient.fetch (node_modules/@coral-xyz/anchor/src/program/namespace/account.ts:168:13)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  3) Protocol Contract - Oracle Integration Tests
       Test 7.3: Liquidation Threshold with Oracle Prices
         Should determine liquidation threshold from oracle:
     Error: Account does not exist or has no data Hajx4D2ojsjfioEkVosNjHEFC6z5zCXms5A6VmwjBapz
      at AccountClient.fetch (node_modules/@coral-xyz/anchor/src/program/namespace/account.ts:168:13)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)



taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ 