
taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ ANCHOR_PROVIDER_URL=https://api.devnet.solana.com ANCHOR_WALLET=~/.config/solana/id.json npx ts-node scripts/close-sorted-troves-devnet.ts
üßπ Closing corrupted SortedTrovesState on devnet...
Admin: 5oMxbgjPWkBYRKbsh3yKrrEC5Ut8y3azHKc787YHY9Ar
Protocol: 9sk8X11GWtZjzXWfkcLMRD6tmuhmiBKgMXsmx9bEh5YQ

State PDA: 4d11FJYR9H7bkgupdDSY1eHU37YP1uwSUGy4NgeNwdkb
SortedTrovesState PDA: EJRheRBBRhnZ2xoXb5DwL9WxBfkjxy3CyGeNhjBgHyRy

Current SortedTrovesState:
  Size: 1
  Head: HNsrwwHs6VwsBDXMbXfsFSXGSAmtmJrtFUgASM8RktZi
  Tail: HNsrwwHs6VwsBDXMbXfsFSXGSAmtmJrtFUgASM8RktZi

‚ö†Ô∏è  WARNING: This will close the SortedTrovesState account!
   - All trove ordering will be reset
   - Next openTrove will create fresh state
   - Existing troves won't be in the sorted list until they call openTrove again

   Press Ctrl+C to cancel, or waiting 3 seconds to proceed...

üì§ Calling reset_sorted_troves instruction...
‚úÖ Success! Transaction signature: 5iEAvBy8NgkjdkkSgEiVyX9rjTuf5soYoWmDmJCXBoVVuNFESDBXdBafGwp6QwxndY7dXae89mWYm13bgsHrU4ds

SortedTrovesState account closed successfully!
‚úÖ Next openTrove call will create fresh, empty sorted list

üí° You can now run your tests:
   ANCHOR_PROVIDER_URL=https://api.devnet.solana.com \
   ANCHOR_WALLET=~/.config/solana/id.json \
   npx ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/protocol-core.ts'

taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ ANCHOR_PROVIDER_URL=https://api.devnet.solana.com \
   ANCHOR_WALLET=~/.config/solana/id.json \
   npx ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/protocol-core.ts'
(node:1329773) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-core.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  Aeroscraper Protocol Core Operations
Using existing stablecoin mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
‚úÖ Using existing devnet collateral mint from vault: Hygyfy8RBxLvoz5b3ffsg9PAvEkT3BJXXdTpVu6ftZYz
Creating admin stablecoin account...
Admin public key: 5oMxbgjPWkBYRKbsh3yKrrEC5Ut8y3azHKc787YHY9Ar
Stablecoin mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
Admin stablecoin account already exists, skipping creation
Admin collateral account already exists
Creating user1 stablecoin account...
Creating user1 collateral account...
Creating user2 stablecoin account...
Creating user2 collateral account...
Skipping stablecoin minting - protocol will mint tokens during operations
Mint authority: 5oMxbgjPWkBYRKbsh3yKrrEC5Ut8y3azHKc787YHY9Ar, Admin: 5oMxbgjPWkBYRKbsh3yKrrEC5Ut8y3azHKc787YHY9Ar, Can mint: true
‚úÖ Minting collateral tokens for testing (localnet)...
‚úÖ Minted and distributed collateral tokens successfully
Creating token account for feeAddress1...
FeeAddress1: 8Lv4UrYHTrzvg9jPVVGNmxWyMrMvrZnCQLWucBzfJyyR
StablecoinMint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
FeeAddress1 token account already exists: GqY4SbdRG4vudGatbLN4d6yfnXXPzPrHDJBKWbgonxQq
FeeAddress2 token account already exists: Hn5V9cYLmZDPwXQcp4vc6VMDzVatpBZBmmwNGXDNj6Cq
Fee1 token account owner: TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA
Expected fee1 owner: 8Lv4UrYHTrzvg9jPVVGNmxWyMrMvrZnCQLWucBzfJyyR
Match: false
Fee2 token account owner: TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA
Expected fee2 owner: GcNwV1nA5bityjNYsWwPLHykpKuuhPzK1AQFBbrPopnX
Match: false
Token accounts created successfully
Oracle already initialized
Fees already initialized
Protocol already initialized
‚úÖ Protocol state has correct addresses
Skipping PDA token account creation (not allowed)
    Core Protocol Operations
SortedTrovesState account doesn't exist yet
üîç Debug - Account addresses being passed:
- oracleProgram: 8zG12srZdYaJPjWzCAJhwyxF7wWTz5spbmehxWpV5Q9M
- oracleState: 483r4BkQvjCU3QkMdgaZLFAvk2XW9N6za2BmjPqHyVtN
- feesProgram: AHmGKukQky3mDHLmFyJYcEaFub69vp2QqeSW7EbVpJjZ
- feesState: EMbFnchCu4t8FgXNYht49MaigXQxToqTcDoSCuQ5x9f2
- Existing troves accounts: 0
‚úÖ Trove opened successfully
      ‚úî Should open a trove successfully (3371ms)
‚úÖ Minting additional collateral for add_collateral test...
‚úÖ Minted 15000000000 additional collateral tokens to user1
  User1 raw balance: 15000000000 units
  User1 UI balance: 15 tokens
  Required amount: 15000000000 units
  User1 raw balance: 15000000000 units
  Required amount: 15000000000 units
‚úÖ Collateral added successfully
      ‚úî Should add collateral to existing trove (7776ms)
‚úÖ Additional loan borrowed successfully
      ‚úî Should borrow additional loan from trove (4398ms)
Staking stablecoins from user1's trove...
‚úÖ Stablecoins staked successfully
      ‚úî Should stake stablecoins in stability pool (1124ms)
SortedTrovesState has 1 troves, head: FMXYUrMvs3HeYi2mV7aXhNHxBkP7MVFr6AvMzbtiVJVQ
‚úì Processed trove FMXYUrMvs3HeYi2mV7aXhNHxBkP7MVFr6AvMzbtiVJVQ, next: null
‚úÖ Fetched 1 valid trove accounts for traversal
‚ùå Second trove opening failed: AnchorError: AnchorError caused by account: Node. Error Code: AccountDiscriminatorMismatch. Error Number: 3002. Error Message: Account discriminator did not match what was expected.
    at Function.parse (/home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/node_modules/@coral-xyz/anchor/src/error.ts:168:14)
    at translateError (/home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/node_modules/@coral-xyz/anchor/src/error.ts:277:35)
    at MethodsBuilder.rpc [as _rpcFn] (/home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  errorLogs: [
    'Program log: AnchorError caused by account: Node. Error Code: AccountDiscriminatorMismatch. Error Number: 3002. Error Message: Account discriminator did not match what was expected.'
  ],
  logs: [
    'Program 9sk8X11GWtZjzXWfkcLMRD6tmuhmiBKgMXsmx9bEh5YQ invoke [1]',
    'Program log: Instruction: OpenTrove',
    'Program 11111111111111111111111111111111 invoke [2]',
    'Program 11111111111111111111111111111111 success',
    'Program 11111111111111111111111111111111 invoke [2]',
    'Program 11111111111111111111111111111111 success',
    'Program 11111111111111111111111111111111 invoke [2]',
    'Program 11111111111111111111111111111111 success',
    'Program 11111111111111111111111111111111 invoke [2]',
    'Program 11111111111111111111111111111111 success',
    'Program log: Opening fee: 100000000000000 aUSD (5%)',
    'Program log: Net loan amount: 1900000000000000 aUSD',
    'Program 8zG12srZdYaJPjWzCAJhwyxF7wWTz5spbmehxWpV5Q9M invoke [2]',
    'Program log: Instruction: GetPrice',
    'Program log: Price query successful',
    'Program log: Denom: SOL',
    'Program log: Decimal: 9',
    'Program log: Publish Time: 1724967841',
    'Program log: Price: 13981741499 ¬± 3495500 x 10^-8',
    'Program log: Real Pyth data extracted successfully using official SDK',
    'Program 8zG12srZdYaJPjWzCAJhwyxF7wWTz5spbmehxWpV5Q9M consumed 7304 of 142320 compute units',
    'Program return: 8zG12srZdYaJPjWzCAJhwyxF7wWTz5spbmehxWpV5Q9M AwAAAFNPTLtxYEEDAAAACKHr0GYAAAAATFY1AAAAAAD4////',
    'Program 8zG12srZdYaJPjWzCAJhwyxF7wWTz5spbmehxWpV5Q9M success',
    'Program log: Oracle CPI executed successfully for denom: SOL',
    'Program log: Price received: 13981741499 for SOL',
    'Program log: DEBUG - Collateral amount: 1000000',
    'Program log: DEBUG - Price: 13981741499',
    'Program log: DEBUG - Price decimal: 8',
    'Program log: DEBUG - Calculated collateral value: 139817414',
    'Program log: DEBUG - Loan amount: 1900000000000000',
    'Program log: DEBUG - Calculated ICR: 7358811',
    'Program log: DEBUG - Minimum ICR required: 115',
    'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [2]',
    'Program log: Instruction: Transfer',
    'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA consumed 4645 of 127430 compute units',
    'Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA success',
    'Program log: AnchorError caused by account: Node. Error Code: AccountDiscriminatorMismatch. Error Number: 3002. Error Message: Account discriminator did not match what was expected.',
    'Program 9sk8X11GWtZjzXWfkcLMRD6tmuhmiBKgMXsmx9bEh5YQ consumed 80095 of 200000 compute units',
    'Program 9sk8X11GWtZjzXWfkcLMRD6tmuhmiBKgMXsmx9bEh5YQ failed: custom program error: 0xbba'
  ],
  error: {
    errorCode: { code: 'AccountDiscriminatorMismatch', number: 3002 },
    errorMessage: 'Account discriminator did not match what was expected',
    comparedValues: undefined,
    origin: 'Node'
  },
  _programErrorStack: ProgramErrorStack {
    stack: [
      [PublicKey [PublicKey(9sk8X11GWtZjzXWfkcLMRD6tmuhmiBKgMXsmx9bEh5YQ)]]
    ]
  }
}
      1) Should open a second trove for user2
‚úÖ Loan partially repaid successfully
      ‚úî Should repay loan partially (2703ms)
‚úÖ Collateral removed successfully
      ‚úî Should remove collateral from trove (4726ms)
‚úÖ Stablecoins unstaked successfully
      ‚úî Should unstake stablecoins from stability pool (3069ms)
    Protocol State Verification
üìä Protocol State:
- Total Debt Amount: 59279999960000000
- Total Collateral Amount: 0
- Total Stake Amount: 3000000000000000
- Minimum Collateral Ratio: 115
- Protocol Fee: 5
‚úÖ Protocol state verification passed
      ‚úî Should verify protocol state after operations (308ms)
üìä User1 Trove State:
- Owner: FMXYUrMvs3HeYi2mV7aXhNHxBkP7MVFr6AvMzbtiVJVQ
- Debt Amount: 2944999998000000
- Collateral Amount: 24997000000
- Collateral Denom: SOL
‚úÖ User trove verification passed
      ‚úî Should verify user trove state (2037ms)
üìä User1 Stake State:
- Owner: FMXYUrMvs3HeYi2mV7aXhNHxBkP7MVFr6AvMzbtiVJVQ
- Amount: 0
- P Snapshot: 1000000000000000000
- Epoch Snapshot: 0
‚úÖ User stake verification passed
      ‚úî Should verify user stake state (647ms)


  10 passing (1m)
  1 failing

  1) Aeroscraper Protocol Core Operations
       Core Protocol Operations
         Should open a second trove for user2:
     Error: AnchorError caused by account: Node. Error Code: AccountDiscriminatorMismatch. Error Number: 3002. Error Message: Account discriminator did not match what was expected.
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)



taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ 