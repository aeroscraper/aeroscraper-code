
taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ ANCHOR_PROVIDER_URL=https://api.devnet.solana.com ANCHOR_WALLET=~/.config/solana/id.json npx ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/protocol-oracle-integration.ts'
(node:1485429) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-oracle-integration.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  Protocol Contract - Oracle Integration Tests

ðŸ”® Setting up Oracle Integration Tests...
ðŸš€ Setting up test environment for devnet...
âœ… Using existing stablecoin mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
âœ… Using existing devnet collateral mint from vault: Hygyfy8RBxLvoz5b3ffsg9PAvEkT3BJXXdTpVu6ftZYz
âœ… Oracle already initialized
âœ… Fees already initialized
âœ… Protocol already initialized
âœ… FeeAddress1 token account already exists: GqY4SbdRG4vudGatbLN4d6yfnXXPzPrHDJBKWbgonxQq
âœ… FeeAddress2 token account already exists: Hn5V9cYLmZDPwXQcp4vc6VMDzVatpBZBmmwNGXDNj6Cq
âœ… Setup complete
    Test 7.1: Get Price via CPI Call
ðŸ“‹ Testing oracle CPI price query...
SortedTrovesState has 2 troves, head: H6jcCMEZJvBsyd16VizDF9E6aosUpzuTvjuhk1JWWavw
âœ“ Processed trove H6jcCMEZJvBsyd16VizDF9E6aosUpzuTvjuhk1JWWavw, next: GLThBB9YBHJgQMVj2wGpbLwKwEMfjr1ieVHaqgueYxUn
âœ“ Processed trove GLThBB9YBHJgQMVj2wGpbLwKwEMfjr1ieVHaqgueYxUn, next: null
âœ… Fetched 2 valid trove accounts for traversal
  âœ… ICR calculated: 147176226%
  âœ… Oracle CPI successfully returned price data
      âœ” Should query oracle price through CPI (9252ms)
    Test 7.2: ICR Calculation with Real Pyth Prices
ðŸ“‹ Testing ICR calculation with Pyth prices...
  Collateral: 10000000000 lamports
  Debt: 950000000000000000 base units
  ICR: 147176226%
âœ… ICR calculation verified with live Pyth prices
      âœ” Should calculate ICR using real-time Pyth prices (1179ms)
    Test 7.3: Liquidation Threshold with Oracle Prices
ðŸ“‹ Testing liquidation threshold with oracle...
  ICR: 147176226%
  Liquidation Threshold: 110%
  Is Liquidatable: false
âœ… Liquidation threshold logic verified
      âœ” Should determine liquidation threshold from oracle (384ms)
    Test 7.4: Multi-Collateral Price Queries
ðŸ“‹ Testing multi-collateral support...
  âœ… SOL: Supported via Pyth feed
  âœ… Protocol architecture supports multi-collateral
  âœ… Each denom stored separately in protocol state
âœ… Multi-collateral architecture verified
      âœ” Should support multiple collateral types
    Test 7.5: Price Staleness Handling
ðŸ“‹ Testing price staleness...
  âœ… Local: Uses get_price_unchecked for testing
  âœ… Devnet: Uses get_price with 5-minute staleness check
  âœ… Staleness validation architecture in place
âœ… Price staleness handling verified
      âœ” Should handle price staleness validation
    Test 7.6: Invalid Oracle Account Rejection
ðŸ“‹ Testing oracle account validation...
  âœ… Oracle program ID validated against state
  âœ… Oracle state account validated against state
  âœ… Covered in CPI security tests
âœ… Oracle account validation verified
      âœ” Should reject invalid oracle accounts
    Test 7.7: Oracle State Validation
ðŸ“‹ Testing oracle state validation...
  âœ… Oracle state address matches protocol state
  âœ… Oracle program ID matches protocol state
âœ… Oracle state validation verified
      âœ” Should validate oracle state PDA (264ms)
    Test 7.8: Price Decimal Conversion
ðŸ“‹ Testing decimal conversion...
  Oracle Address: J83w4HKfqxwcq3BEMMkPFSppX3gqekLyLJBexebFVkix
  âœ… Pyth prices have varying exponents
  âœ… Protocol normalizes to 18 decimals
  âœ… Decimal conversion handled in oracle module
âœ… Decimal conversion verified
      âœ” Should handle different decimal places (245ms)


  8 passing (44s)

taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ 