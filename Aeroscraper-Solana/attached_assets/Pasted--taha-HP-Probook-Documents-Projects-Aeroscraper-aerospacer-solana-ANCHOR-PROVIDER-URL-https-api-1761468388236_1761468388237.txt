
taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ ANCHOR_PROVIDER_URL=https://api.devnet.solana.com    ANCHOR_WALLET=~/.config/solana/id.json    npx ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/protocol-fees-integration.ts'
(node:110485) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-fees-integration.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  Protocol Contract - Fees Integration Tests

üîß Setting up test environment for fee integration tests...
üöÄ Setting up test environment for devnet...
‚úÖ Using existing stablecoin mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
‚úÖ Using existing devnet collateral mint from vault: Hygyfy8RBxLvoz5b3ffsg9PAvEkT3BJXXdTpVu6ftZYz
‚úÖ Oracle already initialized
‚úÖ Fees already initialized
‚úÖ Protocol already initialized
‚úÖ FeeAddress1 token account already exists: GqY4SbdRG4vudGatbLN4d6yfnXXPzPrHDJBKWbgonxQq
‚úÖ FeeAddress2 token account already exists: Hn5V9cYLmZDPwXQcp4vc6VMDzVatpBZBmmwNGXDNj6Cq
‚úÖ Test environment setup complete
  Protocol State: 4d11FJYR9H7bkgupdDSY1eHU37YP1uwSUGy4NgeNwdkb
  Fee State: EMbFnchCu4t8FgXNYht49MaigXQxToqTcDoSCuQ5x9f2
  Stablecoin Mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
‚úÖ Test user created: GTDqWmiJVFdciVWrB9RMkUiGzNA26E1FWv7GmNuSVHoa
    Test 8.1: Fee Distribution via CPI

üìã Testing fee distribution CPI...
  ‚úÖ Fees program: AHmGKukQky3mDHLmFyJYcEaFub69vp2QqeSW7EbVpJjZ
  ‚úÖ Protocol state references correct fee_state_addr: EMbFnchCu4t8FgXNYht49MaigXQxToqTcDoSCuQ5x9f2
  ‚úÖ Fee state initialized:
    - Total fees collected: 704905006003936993
    - Stake enabled: false
  üìù Opening trove to test CPI fee distribution...
Error fetching existing troves: TypeError: Cannot read properties of undefined (reading 'toBase58')
    at Connection.getAccountInfo (/home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/node_modules/@solana/web3.js/src/connection.ts:3623:57)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
      1) Should distribute fees through CPI call
    Test 8.2: Protocol Fee Calculation (5%)

üìã Testing fee calculation...
  Loan amount: 1000000000000000000 aUSD
  Expected fee (5%): 50000000000000000 aUSD
Error fetching existing troves: TypeError: Cannot read properties of undefined (reading 'toBase58')
    at Connection.getAccountInfo (/home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/node_modules/@solana/web3.js/src/connection.ts:3623:57)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
      2) Should calculate 5% protocol fee correctly
    Test 8.3: Stability Pool Mode Distribution

üìã Testing stability pool mode...
  üîÑ Setting stake contract address...
  üîÑ Toggling stake contract to ENABLE stability pool mode...
  ‚úÖ Stability pool mode is ENABLED
  100% of fees should go to stability pool
Error fetching existing troves: TypeError: Cannot read properties of undefined (reading 'toBase58')
    at Connection.getAccountInfo (/home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/node_modules/@solana/web3.js/src/connection.ts:3623:57)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
      3) Should distribute fees to stability pool when enabled
    Test 8.4: Treasury Mode Distribution

üìã Testing treasury mode...
  üîÑ Toggling stake contract to DISABLE (enable treasury mode)...
  ‚úÖ Treasury mode is ENABLED
  50% to fee_address_1, 50% to fee_address_2
Error fetching existing troves: TypeError: Cannot read properties of undefined (reading 'toBase58')
    at Connection.getAccountInfo (/home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/node_modules/@solana/web3.js/src/connection.ts:3623:57)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
      4) Should distribute fees 50/50 to treasury addresses
    Test 8.5: Fee State Validation

üìã Testing fee state validation...
  Protocol state fee_state_addr: EMbFnchCu4t8FgXNYht49MaigXQxToqTcDoSCuQ5x9f2
  Expected fee state PDA: EMbFnchCu4t8FgXNYht49MaigXQxToqTcDoSCuQ5x9f2
  ‚úÖ Fee state PDA is validated in protocol state
  ‚úÖ Prevents fake fee contract injection attacks
‚úÖ Fee state validation verified
      ‚úî Should validate fee state PDA in CPI (394ms)
    Test 8.6: Fee Account Owner Validation

üìã Testing account ownership...
  ‚úÖ Fee distribution validates payer owns payer_token_account
  ‚úÖ Prevents unauthorized fund draining
  ‚úÖ Token account mint validation enforced
‚úÖ Ownership validation verified
      ‚úî Should validate fee account ownership


  2 passing (1m)
  4 failing

  1) Protocol Contract - Fees Integration Tests
       Test 8.1: Fee Distribution via CPI
         Should distribute fees through CPI call:
     TypeError: Cannot read properties of undefined (reading 'toBase58')
      at Connection.getAccountInfo (node_modules/@solana/web3.js/src/connection.ts:3623:57)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  2) Protocol Contract - Fees Integration Tests
       Test 8.2: Protocol Fee Calculation (5%)
         Should calculate 5% protocol fee correctly:
     TypeError: Cannot read properties of undefined (reading 'toBase58')
      at Connection.getAccountInfo (node_modules/@solana/web3.js/src/connection.ts:3623:57)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  3) Protocol Contract - Fees Integration Tests
       Test 8.3: Stability Pool Mode Distribution
         Should distribute fees to stability pool when enabled:
     TypeError: Cannot read properties of undefined (reading 'toBase58')
      at Connection.getAccountInfo (node_modules/@solana/web3.js/src/connection.ts:3623:57)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  4) Protocol Contract - Fees Integration Tests
       Test 8.4: Treasury Mode Distribution
         Should distribute fees 50/50 to treasury addresses:
     TypeError: Cannot read properties of undefined (reading 'toBase58')
      at Connection.getAccountInfo (node_modules/@solana/web3.js/src/connection.ts:3623:57)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)



taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ 