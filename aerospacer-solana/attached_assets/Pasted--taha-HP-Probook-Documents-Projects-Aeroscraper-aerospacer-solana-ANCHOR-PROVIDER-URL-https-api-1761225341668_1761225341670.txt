
taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ ANCHOR_PROVIDER_URL=https://api.devnet.solana.com ANCHOR_WALLET=~/.config/solana/id.json npx ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/protocol-fees-integration.ts'
(node:1490596) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-fees-integration.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  Protocol Contract - Fees Integration Tests

ðŸ”§ Setting up test environment for fee integration tests...
ðŸš€ Setting up test environment for devnet...
âœ… Using existing stablecoin mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
âœ… Using existing devnet collateral mint from vault: Hygyfy8RBxLvoz5b3ffsg9PAvEkT3BJXXdTpVu6ftZYz
âœ… Oracle already initialized
âœ… Fees already initialized
âœ… Protocol already initialized
âœ… FeeAddress1 token account already exists: GqY4SbdRG4vudGatbLN4d6yfnXXPzPrHDJBKWbgonxQq
âœ… FeeAddress2 token account already exists: Hn5V9cYLmZDPwXQcp4vc6VMDzVatpBZBmmwNGXDNj6Cq
âœ… Test environment setup complete
  Protocol State: 4d11FJYR9H7bkgupdDSY1eHU37YP1uwSUGy4NgeNwdkb
  Fee State: EMbFnchCu4t8FgXNYht49MaigXQxToqTcDoSCuQ5x9f2
  Stablecoin Mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
âœ… Test user created: GFzjK7yctvprKYW5HijZzWGaNnBAMX4PeCZBWGFBNT2r
    Test 8.1: Fee Distribution via CPI

ðŸ“‹ Testing fee distribution CPI...
  âœ… Fees program: AHmGKukQky3mDHLmFyJYcEaFub69vp2QqeSW7EbVpJjZ
  âœ… Protocol state references correct fee_state_addr: EMbFnchCu4t8FgXNYht49MaigXQxToqTcDoSCuQ5x9f2
      1) Should distribute fees through CPI call
    Test 8.2: Protocol Fee Calculation (5%)

ðŸ“‹ Testing fee calculation...
      2) Should calculate 5% protocol fee correctly
    Test 8.3: Stability Pool Mode Distribution

ðŸ“‹ Testing stability pool mode...
      3) Should distribute fees to stability pool when enabled
    Test 8.4: Treasury Mode Distribution

ðŸ“‹ Testing treasury mode...
      4) Should distribute fees 50/50 to treasury addresses
    Test 8.5: Fee State Validation

ðŸ“‹ Testing fee state validation...
  Protocol state fee_state_addr: EMbFnchCu4t8FgXNYht49MaigXQxToqTcDoSCuQ5x9f2
  Expected fee state PDA: EMbFnchCu4t8FgXNYht49MaigXQxToqTcDoSCuQ5x9f2
  âœ… Fee state PDA is validated in protocol state
  âœ… Prevents fake fee contract injection attacks
âœ… Fee state validation verified
      âœ” Should validate fee state PDA in CPI (239ms)
    Test 8.6: Fee Account Owner Validation

ðŸ“‹ Testing account ownership...
  âœ… Fee distribution validates payer owns payer_token_account
  âœ… Prevents unauthorized fund draining
  âœ… Token account mint validation enforced
âœ… Ownership validation verified
      âœ” Should validate fee account ownership


  2 passing (12s)
  4 failing

  1) Protocol Contract - Fees Integration Tests
       Test 8.1: Fee Distribution via CPI
         Should distribute fees through CPI call:
     TypeError: Cannot read properties of undefined (reading 'fetch')
      at /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-fees-integration.ts:66:59
      at Generator.next (<anonymous>)
      at fulfilled (tests/protocol-fees-integration.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  2) Protocol Contract - Fees Integration Tests
       Test 8.2: Protocol Fee Calculation (5%)
         Should calculate 5% protocol fee correctly:
     TypeError: Cannot read properties of undefined (reading 'fetch')
      at /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-fees-integration.ts:102:66
      at Generator.next (<anonymous>)
      at /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-fees-integration.ts:41:71
      at new Promise (<anonymous>)
      at __awaiter (tests/protocol-fees-integration.ts:37:12)
      at Context.<anonymous> (tests/protocol-fees-integration.ts:98:65)
      at processImmediate (node:internal/timers:485:21)

  3) Protocol Contract - Fees Integration Tests
       Test 8.3: Stability Pool Mode Distribution
         Should distribute fees to stability pool when enabled:
     TypeError: Cannot read properties of undefined (reading 'fetch')
      at /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-fees-integration.ts:146:66
      at Generator.next (<anonymous>)
      at /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-fees-integration.ts:41:71
      at new Promise (<anonymous>)
      at __awaiter (tests/protocol-fees-integration.ts:37:12)
      at Context.<anonymous> (tests/protocol-fees-integration.ts:142:76)
      at processImmediate (node:internal/timers:485:21)

  4) Protocol Contract - Fees Integration Tests
       Test 8.4: Treasury Mode Distribution
         Should distribute fees 50/50 to treasury addresses:
     TypeError: Cannot read properties of undefined (reading 'fetch')
      at /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-fees-integration.ts:230:66
      at Generator.next (<anonymous>)
      at /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/protocol-fees-integration.ts:41:71
      at new Promise (<anonymous>)
      at __awaiter (tests/protocol-fees-integration.ts:37:12)
      at Context.<anonymous> (tests/protocol-fees-integration.ts:226:73)
      at processImmediate (node:internal/timers:485:21)



taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ 